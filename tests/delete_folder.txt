-- 1. 再帰的に対象フォルダとその子孫を取得
WITH RECURSIVE target_folders AS (
    SELECT id FROM folders WHERE id = :target_folder_id
    UNION ALL
    SELECT f.id
    FROM folders f
    INNER JOIN target_folders tf ON f.parent_id = tf.id
)

-- 2. フォルダを論理削除
UPDATE folders
SET is_deleted = TRUE,
    updated_at = CURRENT_TIMESTAMP
WHERE id IN (SELECT id FROM target_folders);

-- 3. 各フォルダ内の最新バージョンのファイルを論理削除
WITH RECURSIVE target_folders AS (
    SELECT id FROM folders WHERE id = :target_folder_id
    UNION ALL
    SELECT f.id
    FROM folders f
    INNER JOIN target_folders tf ON f.parent_id = tf.id
),
latest_files AS (
    SELECT DISTINCT ON (folder_id, logical_name)
           id
    FROM files
    WHERE folder_id IN (SELECT id FROM target_folders)
      AND is_deleted = FALSE
    ORDER BY folder_id, logical_name, version DESC
)
UPDATE files
SET is_deleted = TRUE,
    updated_at = CURRENT_TIMESTAMP
WHERE id IN (SELECT id FROM latest_files);
